From: Steffen Trumtrar <s.trumtrar@pengutronix.de>
Date: Thu, 16 Apr 2020 15:02:17 +0200
Subject: [PATCH] ARM: imx7: add support for iotmaxx gateway

Signed-off-by: Steffen Trumtrar <s.trumtrar@pengutronix.de>
---
 arch/arm/boot/dts/Makefile                  |   1 +
 arch/arm/boot/dts/imx7d-iotmaxx-gateway.dts | 386 ++++++++++++++++++++++++++++
 2 files changed, 387 insertions(+)
 create mode 100644 arch/arm/boot/dts/imx7d-iotmaxx-gateway.dts

diff --git a/arch/arm/boot/dts/Makefile b/arch/arm/boot/dts/Makefile
index e8dd99201397..ba404c666aad 100644
--- a/arch/arm/boot/dts/Makefile
+++ b/arch/arm/boot/dts/Makefile
@@ -623,6 +623,7 @@ dtb-$(CONFIG_SOC_IMX7D) += \
 	imx7d-colibri-emmc-aster.dtb \
 	imx7d-colibri-emmc-eval-v3.dtb \
 	imx7d-colibri-eval-v3.dtb \
+	imx7d-iotmaxx-gateway.dtb \
 	imx7d-mba7.dtb \
 	imx7d-meerkat96.dtb \
 	imx7d-nitrogen7.dtb \
diff --git a/arch/arm/boot/dts/imx7d-iotmaxx-gateway.dts b/arch/arm/boot/dts/imx7d-iotmaxx-gateway.dts
new file mode 100644
index 000000000000..ae10af84e977
--- /dev/null
+++ b/arch/arm/boot/dts/imx7d-iotmaxx-gateway.dts
@@ -0,0 +1,386 @@
+/dts-v1/;
+
+#include "imx7d.dtsi"
+
+// FIXME: delete when define is fixed in upstream
+#define MX7D_PAD_UART2_RX_DATA__ENET2_MDIO                        0x0130 0x03A0 0x0574 0x6 0x1
+
+/ {
+	model = "IoTMAXX i.MX7D Gateway";
+	compatible = "iotmaxx,imx7d-gateway", "fsl,imx7d";
+
+	chosen {
+		stdout-path = &uart3;
+	};
+
+	memory {
+		device_type = "memory";
+		reg = <0x80000000 0x40000000>;
+	};
+
+	reg_5v_periph: regulator-5v-periph {
+		compatible = "regulator-fixed";
+		regulator-name = "5v_periph";
+		regulator-min-microvolt = <5000000>;
+		regulator-max-microvolt = <5000000>;
+		gpio = <&gpio2 2 GPIO_ACTIVE_HIGH>;
+		enable-active-high;
+		regulator-always-on;
+	};
+
+	reg_usb_gsm_vbus: regulator-usb-gsm-vbus {
+		compatible = "regulator-fixed";
+		regulator-name = "usb_gsm_vbus";
+		regulator-min-microvolt = <5000000>;
+		regulator-max-microvolt = <5000000>;
+		gpio = <&gpio3 2 GPIO_ACTIVE_HIGH>;
+		enable-active-high;
+		regulator-boot-on;
+	};
+
+	reg_usb_otg2_vbus: regulator-usb-otg2-vbus {
+		compatible = "regulator-fixed";
+		regulator-name = "usb_otg2_vbus";
+		regulator-min-microvolt = <5000000>;
+		regulator-max-microvolt = <5000000>;
+		gpio = <&gpio1 7 GPIO_ACTIVE_HIGH>;
+		enable-active-high;
+	};
+};
+
+&fec1 {
+	status = "disabled";
+};
+
+&fec2 {
+	pinctrl-names = "default";
+	pinctrl-0 = <&pinctrl_enet2>,
+		    <&pinctrl_mdio>;
+	assigned-clocks = <&clks IMX7D_ENET2_TIME_ROOT_SRC>,
+			  <&clks IMX7D_ENET2_TIME_ROOT_CLK>;
+	assigned-clock-parents = <&clks IMX7D_PLL_ENET_MAIN_100M_CLK>;
+	assigned-clock-rates = <0>, <100000000>;
+	phy-handle = <&ethphy1>;
+	phy-mode = "rmii";
+	fsl,magic-packet;
+	status = "okay";
+
+	mdio {
+		#address-cells = <1>;
+		#size-cells = <0>;
+
+		ethphy1: ethernet-phy@1 {
+			pinctrl-names = "default";
+			pinctrl-0 = <&pinctrl_rmii_phy_irq>;
+			interrupt-parent = <&gpio2>;
+			interrupts = <25 IRQ_TYPE_LEVEL_LOW>;
+			reset-gpios = <&gpio2 27 GPIO_ACTIVE_LOW>;
+			clocks = <&clks IMX7D_ENET2_REF_ROOT_SRC>;
+			clock-names = "rmii-ref";
+			reg = <1>;
+		};
+	};
+};
+
+&gpio1 {
+	pinctrl-names = "default";
+	pinctrl-0 = <&pinctrl_gpio1>;
+
+	gpio-line-names = "gpio1_highside",
+	"gpio1_lowside",
+	"gpio1_pullup",
+	"n_gpio1_in",
+	"gpio2_highside",
+	"gpio2_lowside",
+	"n_usb_ext_oc",
+	"usb_ext_pwr",
+	"", "",
+	"",
+	"",
+	"", "", "", "", "", "", "", "",
+	"", "", "", "", "", "", "", "",
+	"", "", "", "";
+};
+
+&gpio2 {
+	pinctrl-names = "default";
+	pinctrl-0 = <&pinctrl_gpio2>;
+	status = "okay";
+
+	gpio-line-names = "",
+	"",
+	"5v_periph_en",
+	"",
+	"",
+	"",
+	"",
+	"",
+	"", "",
+	"",
+	"",
+	"", "", "", "", "", "", "", "",
+	"", "", "", "", "", "", "", "",
+	"", "n_usbhub_rst", "", "";
+};
+
+&i2c1 {
+	pinctrl-names = "default";
+	pinctrl-0 = <&pinctrl_i2c1>;
+	status = "okay";
+
+	1wire@18 {
+		compatible = "ds2482";
+		reg = <0x18>;
+	};
+};
+
+/* CTRL_I2C */
+&i2c3 {
+	clock-frequency = <100000>;
+	pinctrl-names = "default";
+	pinctrl-0 = <&pinctrl_i2c3>;
+	status = "okay";
+
+	/* pmic@xx { */
+	/* }; */
+
+	usb_hub: usb-hub@8 {
+		compatible = "smsc,usb3503";
+		reg = <0x8>;
+		pinctrl-names = "default";
+		pinctrl-0 = <&pinctrl_usbhub>;
+		initial-mode = <1>;	/* HUB mode */
+		reset-gpios = <&gpio2 30 GPIO_ACTIVE_LOW>;
+		intn-gpios = <&gpio2 18 GPIO_ACTIVE_LOW>;
+		connect-gpios = <&gpio2 19 GPIO_ACTIVE_HIGH>;
+		clocks = <&clks IMX7D_OSC_24M_CLK>;
+		clock-names = "refclk";
+	};
+
+	tpm: tpm@20 {
+		compatible = "infineon,slb9645tt";
+		reg = <0x20>;
+	};
+
+	eeprom: eeprom@50 {
+		compatible = "atmel,24c01";
+		pagesize = <8>;
+		reg = <0x50>;
+	};
+
+	pcf85363: pcf85363@51 {
+		compatible = "nxp,pcf85363";
+		reg = <0x51>;
+	};
+};
+
+/* EXP_I2C */
+&i2c4 {
+	pinctrl-names = "default";
+	pinctrl-0 = <&pinctrl_i2c4>;
+	status = "okay";
+};
+
+&iomuxc {
+	pinctrl_mdio: mdiogrp {
+		fsl,pins = <
+		MX7D_PAD_UART2_RX_DATA__ENET2_MDIO		0x3	/* ENET_MDIO */
+		MX7D_PAD_UART2_TX_DATA__ENET2_MDC		0x3  	/* ENET_MDC */
+		>;
+	};
+	pinctrl_enet2: enet1grp {
+		fsl,pins = <
+		MX7D_PAD_EPDC_SDCE0__ENET2_RGMII_RX_CTL		0x5	/* ENET2_CRS_DV */
+		MX7D_PAD_EPDC_SDCE1__ENET2_RX_ER		0x5	/* ENET2_RXER */
+		MX7D_PAD_EPDC_SDCE2__ENET2_RGMII_TD0		0x5	/* ENET2_TXD0 */
+		MX7D_PAD_EPDC_SDCE3__ENET2_RGMII_TD1		0x5	/* ENET2_TXD1 */
+		MX7D_PAD_EPDC_SDCLK__ENET2_RGMII_RD0		0x5	/* ENET2_RXD0 */
+		MX7D_PAD_EPDC_SDLE__ENET2_RGMII_RD1		0x5	/* ENET2_RXD1 */
+		MX7D_PAD_EPDC_GDCLK__GPIO2_IO24			0x5	/* ENET2_B-CAST_OFF */
+		MX7D_PAD_EPDC_GDRL__ENET2_RGMII_TX_CTL		0x5	/* ENET2_TXEN */
+		MX7D_PAD_EPDC_GDSP__GPIO2_IO27			0x14	/* !ENET2_RST */
+		MX7D_PAD_EPDC_BDR0__CCM_ENET_REF_CLK2		0x40000001	/* ENET2_TX_CLK */
+		>;
+	};
+	pinctrl_rmii_phy_irq: phygrp {
+		fsl,pins = <
+		MX7D_PAD_EPDC_GDOE__GPIO2_IO25			0x08	/* !ENET2_INT */
+		>;
+	};
+
+	pinctrl_gpio2: gpio2grp {
+		fsl,pins = <
+		MX7D_PAD_EPDC_DATA02__GPIO2_IO2			0x00	/* 5V_PERIPH_EN */
+		>;
+	};
+
+	pinctrl_gpio3: gpio3grp {
+		fsl,pins = <
+		MX7D_PAD_LCD_RESET__GPIO3_IO4			0x00	/* VUSB_GSM_EN */
+		>;
+	};
+
+	pinctrl_gpio4: gpio4grp {
+		fsl,pins = <
+		MX7D_PAD_ECSPI1_MISO__GPIO4_IO18		0x00	/* GSM_POWER_ON_OFF */
+		MX7D_PAD_ECSPI1_MOSI__GPIO4_IO17		0x00	/* GSM_RST */
+		>;
+	};
+
+	pinctrl_i2c1: i2c1grp {
+		fsl,pins = <
+		MX7D_PAD_UART1_RX_DATA__I2C1_SCL		0x40000078
+		MX7D_PAD_UART1_TX_DATA__I2C1_SDA		0x40000078
+		>;
+	};
+
+	pinctrl_i2c3: i2c3grp {
+		fsl,pins = <
+		MX7D_PAD_ENET1_RGMII_RD1__I2C3_SDA		0x40000078
+		MX7D_PAD_ENET1_RGMII_RD0__I2C3_SCL		0x40000078
+		>;
+	};
+
+	pinctrl_i2c4: i2c4grp {
+		fsl,pins = <
+		MX7D_PAD_ENET1_RGMII_TD3__I2C4_SDA		0x40000078
+		MX7D_PAD_ENET1_RGMII_TD2__I2C4_SCL		0x40000078
+		>;
+	};
+	pinctrl_uart3: uart3grp {
+		fsl,pins = <
+		MX7D_PAD_UART3_RX_DATA__UART3_DCE_RX		0x79
+		MX7D_PAD_UART3_TX_DATA__UART3_DCE_TX		0x79
+		MX7D_PAD_UART3_RTS_B__UART3_DCE_RTS		0x79
+		MX7D_PAD_UART3_CTS_B__UART3_DCE_CTS		0x79
+		>;
+	};
+
+	pinctrl_usbhub: usbhubgrp {
+		fsl,pins = <
+		MX7D_PAD_EPDC_PWR_COM__GPIO2_IO30		0x59	/* !USBHUB_RST */
+		MX7D_PAD_EPDC_SDOE__GPIO2_IO18			0x59	/* !USBHUB_INT */
+		MX7D_PAD_EPDC_SDSHR__GPIO2_IO19			0x59	/* USBHUB_CONNECT */
+		>;
+	};
+
+	pinctrl_usdhc2: usdhc2grp {
+		fsl,pins = <
+		MX7D_PAD_SD2_CMD__SD2_CMD			0x59
+		MX7D_PAD_SD2_CLK__SD2_CLK			0x19
+		MX7D_PAD_SD2_DATA0__SD2_DATA0			0x59
+		MX7D_PAD_SD2_DATA1__SD2_DATA1			0x59
+		MX7D_PAD_SD2_DATA2__SD2_DATA2			0x59
+		MX7D_PAD_SD2_DATA3__SD2_DATA3			0x59
+		MX7D_PAD_SD2_CD_B__SD2_CD_B			0x59
+		>;
+	};
+
+	pinctrl_usdhc3: usdhc3grp {
+		fsl,pins = <
+		MX7D_PAD_SD3_CMD__SD3_CMD			0x59
+		MX7D_PAD_SD3_CLK__SD3_CLK			0x19
+		MX7D_PAD_SD3_DATA0__SD3_DATA0			0x59
+		MX7D_PAD_SD3_DATA1__SD3_DATA1			0x59
+		MX7D_PAD_SD3_DATA2__SD3_DATA2			0x59
+		MX7D_PAD_SD3_DATA3__SD3_DATA3			0x59
+		MX7D_PAD_SD3_DATA4__SD3_DATA4			0x59
+		MX7D_PAD_SD3_DATA5__SD3_DATA5			0x59
+		MX7D_PAD_SD3_DATA6__SD3_DATA6			0x59
+		MX7D_PAD_SD3_DATA7__SD3_DATA7			0x59
+		MX7D_PAD_SD3_STROBE__SD3_STROBE			0x19
+		>;
+	};
+
+	pinctrl_usdhc3_100mhz: usdhc3grp_100mhz {
+		fsl,pins = <
+		MX7D_PAD_SD3_CMD__SD3_CMD			0x5a
+		MX7D_PAD_SD3_CLK__SD3_CLK			0x1a
+		MX7D_PAD_SD3_DATA0__SD3_DATA0			0x5a
+		MX7D_PAD_SD3_DATA1__SD3_DATA1			0x5a
+		MX7D_PAD_SD3_DATA2__SD3_DATA2			0x5a
+		MX7D_PAD_SD3_DATA3__SD3_DATA3			0x5a
+		MX7D_PAD_SD3_DATA4__SD3_DATA4			0x5a
+		MX7D_PAD_SD3_DATA5__SD3_DATA5			0x5a
+		MX7D_PAD_SD3_DATA6__SD3_DATA6			0x5a
+		MX7D_PAD_SD3_DATA7__SD3_DATA7			0x5a
+		MX7D_PAD_SD3_STROBE__SD3_STROBE			0x1a
+		>;
+	};
+
+	pinctrl_usdhc3_200mhz: usdhc3grp_200mhz {
+		fsl,pins = <
+		MX7D_PAD_SD3_CMD__SD3_CMD			0x5b
+		MX7D_PAD_SD3_CLK__SD3_CLK			0x1b
+		MX7D_PAD_SD3_DATA0__SD3_DATA0			0x5b
+		MX7D_PAD_SD3_DATA1__SD3_DATA1			0x5b
+		MX7D_PAD_SD3_DATA2__SD3_DATA2			0x5b
+		MX7D_PAD_SD3_DATA3__SD3_DATA3			0x5b
+		MX7D_PAD_SD3_DATA4__SD3_DATA4			0x5b
+		MX7D_PAD_SD3_DATA5__SD3_DATA5			0x5b
+		MX7D_PAD_SD3_DATA6__SD3_DATA6			0x5b
+		MX7D_PAD_SD3_DATA7__SD3_DATA7			0x5b
+		MX7D_PAD_SD3_STROBE__SD3_STROBE			0x1b
+		>;
+	};
+};
+
+&iomuxc_lpsr {
+	pinctrl_gpio1: gpio1grp {
+		fsl,pins = <
+		MX7D_PAD_LPSR_GPIO1_IO00__GPIO1_IO0		0x00
+		MX7D_PAD_LPSR_GPIO1_IO01__GPIO1_IO1		0x00
+		MX7D_PAD_LPSR_GPIO1_IO02__GPIO1_IO2		0x00
+		MX7D_PAD_LPSR_GPIO1_IO03__GPIO1_IO3		0x00
+		MX7D_PAD_LPSR_GPIO1_IO04__GPIO1_IO4		0x00
+		MX7D_PAD_LPSR_GPIO1_IO05__GPIO1_IO5		0x00
+		MX7D_PAD_LPSR_GPIO1_IO06__GPIO1_IO6		0x00
+		MX7D_PAD_LPSR_GPIO1_IO07__GPIO1_IO7		0x00
+		>;
+	};
+};
+
+&uart3 {
+	pinctrl-names = "default";
+	pinctrl-0 = <&pinctrl_uart3>;
+	assigned-clocks = <&clks IMX7D_UART3_ROOT_SRC>;
+	assigned-clock-parents = <&clks IMX7D_OSC_24M_CLK>;
+	uart-has-rtscts;
+	status = "okay";
+};
+
+&usbh {
+	status = "disabled";
+};
+
+&usbotg1 {
+	dr_mode = "otg";
+	disable-over-current;
+	status = "okay";
+};
+
+&usbotg2 {
+	vbus-supply = <&reg_usb_otg2_vbus>;
+	dr_mode = "host";
+	disable-over-current;
+	status = "okay";
+};
+
+&usdhc2 {
+	pinctrl-names = "default";
+	pinctrl-0 = <&pinctrl_usdhc2>;
+	status = "okay";
+};
+
+&usdhc3 {
+	pinctrl-names = "default", "state_100mhz", "state_200mhz";
+	pinctrl-0 = <&pinctrl_usdhc3>;
+	pinctrl-1 = <&pinctrl_usdhc3_100mhz>;
+	pinctrl-2 = <&pinctrl_usdhc3_200mhz>;
+	assigned-clocks = <&clks IMX7D_USDHC3_ROOT_CLK>;
+	assigned-clock-rates = <400000000>;
+	bus-width = <8>;
+	fsl,tuning-step = <2>;
+	non-removable;
+	status = "okay";
+};
