Bootstrap
=========

When the eMMC is unflashed the board falls back to serial boot mode.
Start barebox with:

  platform-iotmaxx-gateway/build-target/barebox-2020.04.0/scripts/imx/imx-usb-loader platform-iotmaxx-gateway/images/barebox-iotmaxx-imx7d-gateway.img

Then the bootloader can be flashed to the eMMC via network with

  barebox@IoTMAXX i.MX7D Gateway:/ barebox_update /mnt/tftp/barebox-iotmaxx-imx7d-gateway.img

barebox does atomic updates. That means, that barebox_update will always flash the new barebox
to the boot partition that is not currently booted and then update the mmc2.boot variable.

To check the activated boot partition:

  barebox@IoTMAXX i.MX7D Gateway:/ devinfo mmc2          
  Host information:
    current clock: 52000000
    current buswidth: 8
    capabilities: 4bit 8bit sd-hs mmc-hs 
  Card information:
    Attached is a MMC card
    Version: 5.1
    Capacity: 7456 MiB
    High capacity card
     CID: 11010030-30384742-3004348F-C3EEA600
     CSD: D0270032-8F5903FF-FFFFFFE7-86400000
    Max. transfer speed: 52000000 Hz
    capabilities: 4bit mmc-hs mmc-52MHz 
    Manufacturer ID: 11
    OEM/Application ID: 0100
    Product name: '008GB'
    Product revision: 3.0
    Serial no: 881837038
    Manufacturing date: 10.2019
  Parameters:
    boot: boot0 (type: enum) (values: "disabled", "boot0", "boot1", "user")
    probe: 0 (type: bool)

or just

  barebox@IoTMAXX i.MX7D Gateway:/ echo $mmc2.boot
  boot0

After the update barebox will boot from the other boot partition.

eMMC BKOPS
==========
To optimize write performance enable BKOPS in the eMMC with
  mmc_extcsd -b /dev/mmc2
This operation is NOT reversible! Linux supports this feature since v3.7.

Fastboot
========

To copy the image to the eMMC via fastboot and optionally update barebox,
first export the mmc2 via fastboot
  barebox@IoTMAXX i.MX7D Gateway:/ usbgadget -A -b

Then on the host PC
  fastboot flash root platform-iotmaxx-gateway/images/gateway.hdimg

To update barebox
  fastboot flash bbu-emmc platform-iotmaxx-gateway/images/barebox-iotmaxx-imx7d-gateway.img

Now reset the board.

Boot from eMMC
==============

To fuse the system to boot from eMMC a small script is added to barebox. Just issue

  barebox@IoTMAXX i.MX7D Gateway:/ fuse-boot-emmc


GSM Modem
=========

For testing purposes a small script sim_setup.sh is included in projectroot/usr/bin.
This sets the GPIOs for SIM-card 2 usage.

The modem can then be used with

oot@Gateway:~ mmcli -m 1
  --------------------------------
  General  |            dbus path: /org/freedesktop/ModemManager1/Modem/1
           |            device id: dd1983f3c13bd25a19647d2fca076dad57ef5c57
  --------------------------------
  Hardware |         manufacturer: Quectel
           |                model: EC21
           |    firmware revision: EC21EFAR06A02M4G
           |            supported: gsm-umts, lte
           |              current: gsm-umts, lte
           |         equipment id: 867962042149685
  --------------------------------
  System   |               device: /sys/devices/platform/soc/30800000.bus/30b30000.usb/ci_hdrc.1/usb1/1-1/1-1.1
           |              drivers: option1
           |               plugin: Quectel
           |         primary port: ttyUSB2
           |                ports: ttyUSB0 (qcdm), ttyUSB2 (at), ttyUSB3 (at)
  --------------------------------
  Numbers  |                  own: +4915140075573
  --------------------------------
  Status   |       unlock retries: sim-pin (3), sim-puk (10), sim-pin2 (3), sim-puk2 (10)
           |                state: disabled
           |          power state: on
           |       signal quality: 0% (cached)
  --------------------------------
  Modes    |            supported: allowed: 2g, 3g, 4g; preferred: none
           |              current: allowed: 2g, 3g, 4g; preferred: none
  --------------------------------
  IP       |            supported: ipv4, ipv6, ipv4v6
  --------------------------------
  3GPP     |                 imei: 867962042149685
  --------------------------------
  3GPP EPS | ue mode of operation: csps-2
  --------------------------------
  SIM      |            dbus path: /org/freedesktop/ModemManager1/SIM/0 

After every reset the modem increases its number.

ModemManager
============

To add a new connection issue

root@Gateway:~ nmcli c add type gsm ifname "*" con-name telekom apn "internet.t-mobile"
Connection 'telekom' (17bdada4-4361-4eca-8506-f6eab6b26a48) successfully added.

And then to enable the connection

root@Gateway:~ nmcli c up telekom
Connection successfully activated (D-Bus active path: /org/freedesktop/NetworkManager/ActiveConnection/3)

root@Gateway:~ mmcli -m 1
  --------------------------------
  General  |            dbus path: /org/freedesktop/ModemManager1/Modem/1
           |            device id: 794eb538900f787165b66d8af66496a4e7cd0c8b
  --------------------------------
  Hardware |         manufacturer: QUALCOMM INCORPORATED
           |                model: QUECTEL Mobile Broadband Module
           |    firmware revision: EC21EFAR06A02M4G
           |       carrier config: default
           |         h/w revision: 10000
           |            supported: gsm-umts, lte
           |              current: gsm-umts, lte
           |         equipment id: 867962042149685
  --------------------------------
  System   |               device: /sys/devices/platform/soc/30800000.bus/30b30000.usb/ci_hdrc.1/usb1/1-1/1-1.1
           |              drivers: qmi_wwan, option1
           |               plugin: Quectel
           |         primary port: cdc-wdm0
           |                ports: cdc-wdm0 (qmi), ttyUSB0 (qcdm), ttyUSB2 (at), wwan0 (net), 
           |                       ttyUSB3 (at)
  --------------------------------
  Numbers  |                  own: 4915140075573
  --------------------------------
  Status   |                 lock: sim-pin2
           |       unlock retries: sim-pin (3), sim-puk (10), sim-pin2 (3), sim-puk2 (10)
           |                state: connected
           |          power state: on
           |          access tech: gsm
           |       signal quality: 41% (recent)
  --------------------------------
  Modes    |            supported: allowed: 2g; preferred: none
           |                       allowed: 3g; preferred: none
           |                       allowed: 4g; preferred: none
           |                       allowed: 2g, 3g; preferred: 3g
           |                       allowed: 2g, 3g; preferred: 2g
           |                       allowed: 2g, 4g; preferred: 4g
           |                       allowed: 2g, 4g; preferred: 2g
           |                       allowed: 3g, 4g; preferred: 3g
           |                       allowed: 3g, 4g; preferred: 4g
           |                       allowed: 2g, 3g, 4g; preferred: 4g
           |                       allowed: 2g, 3g, 4g; preferred: 3g
           |                       allowed: 2g, 3g, 4g; preferred: 2g
           |              current: allowed: 2g, 3g, 4g; preferred: 4g
  --------------------------------
  Bands    |            supported: egsm, dcs, utran-1, utran-5, utran-8, eutran-1, eutran-3, 
           |                       eutran-5, eutran-7, eutran-8, eutran-20
           |              current: egsm, dcs, utran-1, utran-5, utran-8, eutran-1, eutran-3, 
           |                       eutran-5, eutran-7, eutran-8, eutran-20
  --------------------------------
  IP       |            supported: ipv4, ipv6, ipv4v6
  --------------------------------
  3GPP     |                 imei: 867962042149685
           |          operator id: 26201
           |         registration: home
  --------------------------------
  3GPP EPS | ue mode of operation: csps-2
  --------------------------------
  SIM      |            dbus path: /org/freedesktop/ModemManager1/SIM/0
  --------------------------------
  Bearer   |            dbus path: /org/freedesktop/ModemManager1/Bearer/0


Overlays
========

Barebox can load and apply devicetree overlays that are found in /boot on the rootfs.
To add overlays just put them in local-src/expansion-boards/ and add them to
rules/expansion-boards.{in,make}.

To apply them in barebox issue 

  barebox@IoTMAXX i.MX7D Gateway:/ overlay_map.sh

If an EEPROM is found (for testing purposes /dev/eeprom0 is used, this is on the baseboard !!!)
the first 16 bytes are read out and used as an identifier for the devicetree that is to be loaded.
E.g. if the first 16 bytes are "test", the script searches for a file /mnt/mmc2.4/boot/test.dto and
applies it to the devicetree that is handed to the kernel.
